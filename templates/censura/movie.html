{% extends 'censura/base.html' %}

{% block title_block %}
	{% if movie %}
        {{ movie.name }}
    {% endif %}
{% endblock %}

{% block body_block %}
    {% if movie %}
        <h1><strong>{{ movie.name }}</strong></h1>
        <div>
            <img src="{{ movie.image.url }}" alt="{{ movie.name }}">
            <button class="favourite-btn" data-movie-slug="{{ movie.slug }}">
                <span class="heart {% if movie in user.userprofile.likes.all %}filled{% else %}empty{% endif %}">
                    {% if movie in user.userprofile.likes.all %}
                        ❤️
                    {% else %}
                        ♡
                    {% endif %}
                </span>
            </button>

            <ul>
                <li><strong>Release date:</strong> {{ movie.release_date }}</li>
                <li><strong>Director:</strong> {{ movie.director }}</li>
                <li><strong>Genres:</strong></li>
                    <ul>
                    {% for genre in movie.genre.all %}
                        <li>{{ genre.name }}</li>
                    {% endfor %}
                    </ul>
            </ul>
        </div>
    {% else %}
        This movie is not in the database.
    {% endif %}
    <div>{{ movie.description }}</div>

    <!-- Review section -->
    <div class="review-section">
        <h3>Your Reviews</h3>

        {% if user.is_authenticated %}
            <!-- Display existing user reviews -->
            {% if user_has_reviewed %}
            <div class="movie-reviews">
                {% for review in user_reviews %}
                <a href="{% if movie.slug %}{% url 'censura:create_review' movie.slug %}{% else %}#{% endif %}" class="btn btn-primary">Edit Review</a>
                <div class="review">
                    <h4> Reviewed by {{ review.user.username }}</h4>
                    <p>Rating: {{ review.rating }}/10</p>
                    <p>{{ review.text }}</p>
                    <p class="review-date">{{ review.created_at|date:"F d, Y" }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>Have you watched this film and want to share your thoughts?</p>
            <a href="{% if movie.slug %}{% url 'censura:create_review' movie.slug %}{% else %}# No URL available{% endif %}" class="btn btn-primary">Write a Review</a>
            {% endif %}
        {% else %}
            <p><a href="{% url 'censura:login' %}">Login</a> to write a review.</p>
        {% endif %}
    </div>

    
    <h3>All Reviews</h3>
    <label for="sort">Sort by:</label>
    <select id="sort" class="sort-dropdown">
        <option value="created_at" selected>Newest</option>
        <option value="likes">Most Liked</option>
        <option value="rating">Highest Rated</option>
    </select>
    <div class="review-section" data-movie-slug="{{ movie.slug }}">
        <!-- Display top reviews -->
        {% if all_reviews %}
        <div class="movie-reviews">
            {% for review in all_reviews %}
            <div class="review">
                <h4>Reviewed by {{ review.user.username }}</h4>
                <p>Rating: {{ review.rating }}/10</p>
                <p>{{ review.text }}</p>
                <p class="review-date">{{ review.created_at|date:"F d, Y" }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No reviews yet. Be the first to review!</p>
        {% endif %}
    </div>
{% endblock %}